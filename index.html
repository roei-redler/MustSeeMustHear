<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>StreamHub - ניהול תכנים אישי</title>
    
    <!-- External CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Rubik:wght@300;400;500;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --primary-bg: #0f0f0f;
            --secondary-bg: #1a1a1a;
            --card-bg: #242424;
            --hover-bg: #2a2a2a;
            --text-primary: #ffffff;
            --text-secondary: #a0a0a0;
            --accent-color: #e50914;
            --accent-hover: #ff0a16;
            --success-color: #46d369;
            --warning-color: #ffa500;
            --border-color: rgba(255, 255, 255, 0.1);
            --shadow-lg: 0 10px 40px rgba(0, 0, 0, 0.5);
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Rubik', sans-serif;
            background: linear-gradient(135deg, var(--primary-bg) 0%, #1a0f1a 100%);
            color: var(--text-primary);
            min-height: 100vh;
            direction: rtl;
        }
        
        /* Navigation */
        .navbar-custom {
            background: linear-gradient(to bottom, rgba(0,0,0,0.9), rgba(0,0,0,0.7));
            backdrop-filter: blur(20px);
            padding: 1rem 0;
            position: fixed;
            width: 100%;
            top: 0;
            z-index: 1000;
            border-bottom: 1px solid var(--border-color);
        }
        
        .navbar-brand {
            font-size: 1.8rem;
            font-weight: 700;
            background: linear-gradient(135deg, var(--accent-color), var(--accent-hover));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            text-decoration: none;
        }
        
        .nav-pills .nav-link {
            color: var(--text-secondary);
            background: transparent;
            border: none;
            padding: 0.5rem 1.5rem;
            margin: 0 0.5rem;
            border-radius: 25px;
            transition: all 0.3s ease;
            font-weight: 500;
        }
        
        .nav-pills .nav-link:hover {
            color: var(--text-primary);
            background: rgba(255, 255, 255, 0.05);
        }
        
        .nav-pills .nav-link.active {
            color: var(--text-primary);
            background: var(--accent-color);
        }
        
        /* Main Container */
        .main-container {
            margin-top: 80px;
            padding: 2rem;
            max-width: 1400px;
            margin-left: auto;
            margin-right: auto;
        }
        
        /* Stats Cards */
        .stats-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }
        
        .stat-card {
            background: linear-gradient(135deg, var(--card-bg), var(--secondary-bg));
            padding: 1.5rem;
            border-radius: 15px;
            border: 1px solid var(--border-color);
            transition: transform 0.3s ease;
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow-lg);
        }
        
        .stat-number {
            font-size: 2.5rem;
            font-weight: 700;
            background: linear-gradient(135deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .stat-label {
            color: var(--text-secondary);
            font-size: 0.9rem;
            margin-top: 0.5rem;
        }
        
        /* Add Content Section */
        .add-content-section {
            background: var(--card-bg);
            padding: 2rem;
            border-radius: 20px;
            margin-bottom: 2rem;
            border: 1px solid var(--border-color);
        }
        
        .youtube-input-group {
            display: flex;
            gap: 1rem;
            margin-bottom: 1rem;
        }
        
        .youtube-input {
            flex: 1;
            padding: 1rem;
            background: var(--secondary-bg);
            border: 2px solid var(--border-color);
            color: var(--text-primary);
            border-radius: 10px;
            font-size: 1rem;
            transition: all 0.3s ease;
        }
        
        .youtube-input:focus {
            outline: none;
            border-color: var(--accent-color);
            background: rgba(255, 255, 255, 0.05);
        }
        
        .content-type-selector {
            display: flex;
            gap: 1rem;
            margin-bottom: 1rem;
        }
        
        .type-btn {
            flex: 1;
            padding: 0.8rem;
            background: var(--secondary-bg);
            border: 2px solid var(--border-color);
            color: var(--text-secondary);
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 1rem;
        }
        
        .type-btn:hover {
            background: var(--hover-bg);
            color: var(--text-primary);
        }
        
        .type-btn.active {
            background: var(--accent-color);
            color: white;
            border-color: var(--accent-color);
        }
        
        .btn-add {
            padding: 1rem 2rem;
            background: linear-gradient(135deg, var(--accent-color), var(--accent-hover));
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 1.1rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .btn-add:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(229, 9, 20, 0.3);
        }
        
        /* Video Preview */
        .video-preview {
            display: none;
            margin-top: 1rem;
            padding: 1rem;
            background: var(--secondary-bg);
            border-radius: 10px;
            border: 1px solid var(--border-color);
        }
        
        .video-preview.active {
            display: flex;
            gap: 1rem;
            align-items: center;
        }
        
        .preview-thumbnail {
            width: 120px;
            height: 90px;
            border-radius: 8px;
            object-fit: cover;
        }
        
        .preview-info {
            flex: 1;
        }
        
        .preview-title {
            font-size: 1.1rem;
            font-weight: 500;
            margin-bottom: 0.5rem;
        }
        
        .preview-channel {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }
        
        /* Tabs Section */
        .tabs-container {
            margin-bottom: 2rem;
        }
        
        .main-tabs {
            display: flex;
            gap: 1rem;
            margin-bottom: 1.5rem;
            border-bottom: 2px solid var(--border-color);
            padding-bottom: 1rem;
        }
        
        .main-tab {
            padding: 0.8rem 2rem;
            background: transparent;
            border: none;
            color: var(--text-secondary);
            font-size: 1.2rem;
            font-weight: 500;
            cursor: pointer;
            position: relative;
            transition: all 0.3s ease;
        }
        
        .main-tab:hover {
            color: var(--text-primary);
        }
        
        .main-tab.active {
            color: var(--accent-color);
        }
        
        .main-tab.active::after {
            content: '';
            position: absolute;
            bottom: -1rem;
            left: 0;
            right: 0;
            height: 2px;
            background: var(--accent-color);
        }
        
        .sub-tabs {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 2rem;
        }
        
        .sub-tab {
            padding: 0.5rem 1.5rem;
            background: var(--secondary-bg);
            border: 1px solid var(--border-color);
            border-radius: 20px;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.9rem;
        }
        
        .sub-tab:hover {
            background: var(--hover-bg);
            color: var(--text-primary);
        }
        
        .sub-tab.active {
            background: var(--accent-color);
            color: white;
            border-color: var(--accent-color);
        }
        
        .sub-tab i {
            margin-left: 0.5rem;
        }
        
        /* Content Grid */
        .content-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 1.5rem;
            margin-top: 2rem;
        }
        
        .content-card {
            background: var(--card-bg);
            border-radius: 12px;
            overflow: hidden;
            transition: all 0.3s ease;
            border: 1px solid var(--border-color);
            cursor: pointer;
            position: relative;
        }
        
        .content-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow-lg);
            border-color: var(--accent-color);
        }
        
        .card-thumbnail {
            width: 100%;
            height: 160px;
            object-fit: cover;
            background: var(--secondary-bg);
        }
        
        .card-body {
            padding: 1rem;
        }
        
        .card-title {
            font-size: 1rem;
            font-weight: 500;
            margin-bottom: 0.5rem;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        
        .card-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid var(--border-color);
        }
        
        .card-type {
            display: inline-flex;
            align-items: center;
            gap: 0.3rem;
            padding: 0.3rem 0.8rem;
            background: var(--secondary-bg);
            border-radius: 15px;
            font-size: 0.8rem;
            color: var(--text-secondary);
        }
        
        .card-type.movie {
            background: rgba(229, 9, 20, 0.2);
            color: #ff6b6b;
        }
        
        .card-type.series {
            background: rgba(102, 126, 234, 0.2);
            color: #667eea;
        }
        
        .card-type.music {
            background: rgba(70, 211, 105, 0.2);
            color: #46d369;
        }
        
        .card-user {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.85rem;
            color: var(--text-secondary);
        }
        
        .user-avatar {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea, #764ba2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
            color: white;
        }
        
        .card-actions {
            position: absolute;
            top: 10px;
            left: 10px;
            display: flex;
            gap: 0.5rem;
        }
        
        .action-btn {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(10px);
            border: 1px solid var(--border-color);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .action-btn:hover {
            background: var(--accent-color);
            transform: scale(1.1);
        }
        
        .action-btn.completed {
            background: var(--success-color);
        }
        
        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 4rem 2rem;
            color: var(--text-secondary);
        }
        
        .empty-icon {
            font-size: 4rem;
            margin-bottom: 1rem;
            opacity: 0.5;
        }
        
        .empty-title {
            font-size: 1.5rem;
            margin-bottom: 0.5rem;
        }
        
        .empty-description {
            font-size: 1rem;
        }
        
        /* Loading */
        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 200px;
        }
        
        .spinner {
            width: 50px;
            height: 50px;
            border: 3px solid var(--border-color);
            border-top-color: var(--accent-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Toast */
        .toast-container {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            z-index: 9999;
        }
        
        .toast-custom {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            padding: 1rem 1.5rem;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 1rem;
            min-width: 300px;
            animation: slideIn 0.3s ease;
            box-shadow: var(--shadow-lg);
        }
        
        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        .toast-custom.success {
            border-color: var(--success-color);
        }
        
        .toast-custom.error {
            border-color: var(--accent-color);
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .content-grid {
                grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            }
            
            .stats-container {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .youtube-input-group {
                flex-direction: column;
            }
            
            .content-type-selector {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar-custom">
        <div class="container-fluid px-4">
            <div class="d-flex justify-content-between align-items-center">
                <a href="#" class="navbar-brand">
                    <i class="fas fa-play-circle me-2"></i>StreamHub
                </a>
                <div class="d-flex align-items-center gap-3">
                    <span class="text-secondary" id="userName">טוען...</span>
                    <button class="btn btn-sm btn-outline-danger" onclick="logout()">
                        <i class="fas fa-sign-out-alt me-1"></i> התנתק
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Container -->
    <div class="main-container">
        <!-- Statistics -->
        <div class="stats-container">
            <div class="stat-card">
                <div class="stat-number" id="totalCount">0</div>
                <div class="stat-label">סה"כ תכנים</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="toCompleteCount">0</div>
                <div class="stat-label">להשלמה</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="completedCount">0</div>
                <div class="stat-label">הושלמו</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="moviesCount">0</div>
                <div class="stat-label">סרטים</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="seriesCount">0</div>
                <div class="stat-label">סדרות</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="musicCount">0</div>
                <div class="stat-label">מוזיקה</div>
            </div>
        </div>

        <!-- Add Content Section -->
        <div class="add-content-section">
            <h3 class="mb-3">הוסף תוכן חדש מ-YouTube</h3>
            
            <div class="youtube-input-group">
                <input type="text" 
                       class="youtube-input" 
                       id="youtubeUrl" 
                       placeholder="הדבק כאן קישור YouTube...">
            </div>
            
            <div class="content-type-selector">
                <button class="type-btn active" data-type="movie">
                    <i class="fas fa-film"></i> סרט
                </button>
                <button class="type-btn" data-type="series">
                    <i class="fas fa-tv"></i> סדרה
                </button>
                <button class="type-btn" data-type="music">
                    <i class="fas fa-music"></i> מוזיקה
                </button>
            </div>
            
            <div class="video-preview" id="videoPreview">
                <img class="preview-thumbnail" id="previewThumbnail" src="" alt="">
                <div class="preview-info">
                    <div class="preview-title" id="previewTitle"></div>
                    <div class="preview-channel" id="previewChannel"></div>
                </div>
            </div>
            
            <button class="btn-add" onclick="addContent()">
                <i class="fas fa-plus-circle me-2"></i> הוסף לרשימה
            </button>
        </div>

        <!-- Main Tabs -->
        <div class="tabs-container">
            <div class="main-tabs">
                <button class="main-tab active" data-status="to_complete">
                    להשלמה
                </button>
                <button class="main-tab" data-status="completed">
                    הושלמו
                </button>
            </div>

            <!-- Sub Tabs -->
            <div class="sub-tabs">
                <button class="sub-tab active" data-filter="all">
                    <i class="fas fa-border-all"></i> הכל
                </button>
                <button class="sub-tab" data-filter="movie">
                    <i class="fas fa-film"></i> סרטים
                </button>
                <button class="sub-tab" data-filter="series">
                    <i class="fas fa-tv"></i> סדרות
                </button>
                <button class="sub-tab" data-filter="music">
                    <i class="fas fa-music"></i> מוזיקה
                </button>
            </div>

            <!-- Content Grid -->
            <div class="content-grid" id="contentGrid">
                <div class="loading">
                    <div class="spinner"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div class="toast-container" id="toastContainer"></div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        // Configuration
        const SUPABASE_URL = 'https://yxszxzbymtssvypumqfe.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inl4c3p4emJ5bXRzc3Z5cHVtcWZlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYzMjkyMjUsImV4cCI6MjA3MTkwNTIyNX0.13t1BXPqPhUaKB6xviale4DZ6cGc23dcNyKKh_0kBg0';
        const YOUTUBE_API_KEY = 'AIzaSyB9gQvaaJqer5qyv7kHP2-NfDwAnPkiQZQ';
        
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        
        // State
        let currentUser = null;
        let currentStatus = 'to_complete';
        let currentFilter = 'all';
        let selectedContentType = 'movie';
        let currentVideoData = null;
        let allContent = [];
        
        // Initialize
        document.addEventListener('DOMContentLoaded', async () => {
            await checkAuth();
            setupEventListeners();
            loadContent();
            updateStats();
        });
        
        // Authentication
        async function checkAuth() {
            const { data: { user } } = await supabase.auth.getUser();
            
            if (!user) {
                window.location.href = '/login.html';
                return;
            }
            
            currentUser = user;
            document.getElementById('userName').textContent = user.email.split('@')[0];
        }
        
        async function logout() {
            await supabase.auth.signOut();
            window.location.href = '/login.html';
        }
        
        // Event Listeners
        function setupEventListeners() {
            // YouTube URL input
            document.getElementById('youtubeUrl').addEventListener('input', debounce(async (e) => {
                const url = e.target.value;
                if (isValidYouTubeUrl(url)) {
                    await fetchYouTubeData(url);
                } else {
                    hideVideoPreview();
                }
            }, 500));
            
            // Content type buttons
            document.querySelectorAll('.type-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.type-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    selectedContentType = btn.dataset.type;
                });
            });
            
            // Main tabs
            document.querySelectorAll('.main-tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    document.querySelectorAll('.main-tab').forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    currentStatus = tab.dataset.status;
                    filterContent();
                });
            });
            
            // Sub tabs
            document.querySelectorAll('.sub-tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    document.querySelectorAll('.sub-tab').forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    currentFilter = tab.dataset.filter;
                    filterContent();
                });
            });
        }
        
        // YouTube Functions
        function isValidYouTubeUrl(url) {
            const patterns = [
                /^https?:\/\/(www\.)?youtube\.com\/watch\?v=([a-zA-Z0-9_-]{11})/,
                /^https?:\/\/youtu\.be\/([a-zA-Z0-9_-]{11})/,
                /^https?:\/\/(www\.)?youtube\.com\/embed\/([a-zA-Z0-9_-]{11})/
            ];
            
            return patterns.some(pattern => pattern.test(url));
        }
        
        function extractYouTubeId(url) {
            const patterns = [
                /[?&]v=([a-zA-Z0-9_-]{11})/,
                /youtu\.be\/([a-zA-Z0-9_-]{11})/,
                /embed\/([a-zA-Z0-9_-]{11})/
            ];
            
            for (const pattern of patterns) {
                const match = url.match(pattern);
                if (match) return match[1];
            }
            
            return null;
        }
        
        async function fetchYouTubeData(url) {
            const videoId = extractYouTubeId(url);
            if (!videoId) return;
            
            try {
                const response = await fetch(
                    `https://www.googleapis.com/youtube/v3/videos?part=snippet,contentDetails&id=${videoId}&key=${YOUTUBE_API_KEY}`
                );
                
                const data = await response.json();
                
                if (data.items && data.items.length > 0) {
                    const video = data.items[0];
                    currentVideoData = {
                        youtube_id: videoId,
                        youtube_url: url,
                        title: video.snippet.title,
                        description: video.snippet.description,
                        thumbnail_url: video.snippet.thumbnails.high.url,
                        channel_name: video.snippet.channelTitle,
                        duration: parseDuration(video.contentDetails.duration)
                    };
                    
                    showVideoPreview(currentVideoData);
                }
            } catch (error) {
                console.error('Error fetching YouTube data:', error);
                showToast('שגיאה בטעינת נתוני הסרטון', 'error');
            }
        }
        
        function parseDuration(duration) {
            const match = duration.match(/PT(?:(\d+)H)?(?:(\d+)M)?(?:(\d+)S)?/);
            if (!match) return '';
            
            const hours = parseInt(match[1] || 0);
            const minutes = parseInt(match[2] || 0);
            const seconds = parseInt(match[3] || 0);
            
            const parts = [];
            if (hours > 0) parts.push(`${hours}:${minutes.toString().padStart(2, '0')}`);
            else parts.push(minutes.toString());
            parts.push(seconds.toString().padStart(2, '0'));
            
            return parts.join(':');
        }
        
        function showVideoPreview(videoData) {
            const preview = document.getElementById('videoPreview');
            document.getElementById('previewThumbnail').src = videoData.thumbnail_url;
            document.getElementById('previewTitle').textContent = videoData.title;
            document.getElementById('previewChannel').textContent = videoData.channel_name;
            preview.classList.add('active');
        }
        
        function hideVideoPreview() {
            document.getElementById('videoPreview').classList.remove('active');
            currentVideoData = null;
        }
        
        // Content Management
        async function addContent() {
            if (!currentVideoData) {
                showToast('אנא הדבק קישור YouTube תקין', 'error');
                return;
            }
            
            try {
                const { data, error } = await supabase
                    .from('user_content')
                    .insert({
                        user_id: currentUser.id,
                        ...currentVideoData,
                        content_type: selectedContentType,
                        status: 'to_complete',
                        added_by_username: currentUser.email.split('@')[0],
                        added_by_avatar: currentUser.user_metadata?.avatar_url || null
                    })
                    .select();
                
                if (error) {
                    if (error.code === '23505') {
                        showToast('תוכן זה כבר קיים ברשימה שלך', 'error');
                    } else {
                        throw error;
                    }
                    return;
                }
                
                showToast('התוכן נוסף בהצלחה!', 'success');
                document.getElementById('youtubeUrl').value = '';
                hideVideoPreview();
                await loadContent();
                await updateStats();
                
            } catch (error) {
                console.error('Error adding content:', error);
                showToast('שגיאה בהוספת התוכן', 'error');
            }
        }
        
        async function loadContent() {
            try {
                const { data, error } = await supabase
                    .from('user_content')
                    .select('*')
                    .eq('user_id', currentUser.id)
                    .order('created_at', { ascending: false });
                
                if (error) throw error;
                
                allContent = data || [];
                filterContent();
                
            } catch (error) {
                console.error('Error loading content:', error);
                showToast('שגיאה בטעינת התכנים', 'error');
            }
        }
        
        function filterContent() {
            let filtered = allContent.filter(item => item.status === currentStatus);
            
            if (currentFilter !== 'all') {
                filtered = filtered.filter(item => item.content_type === currentFilter);
            }
            
            renderContent(filtered);
        }
        
        function renderContent(items) {
            const grid = document.getElementById('contentGrid');
            
            if (items.length === 0) {
                grid.innerHTML = `
                    <div class="empty-state" style="grid-column: 1/-1;">
                        <div class="empty-icon">
                            <i class="fas fa-inbox"></i>
                        </div>
                        <div class="empty-title">אין תכנים להצגה</div>
                        <div class="empty-description">
                            ${currentStatus === 'to_complete' ? 
                              'הוסף תכנים חדשים מ-YouTube כדי להתחיל' : 
                              'סמן תכנים כהושלמו כדי לראות אותם כאן'}
                        </div>
                    </div>
                `;
                return;
            }
            
            grid.innerHTML = items.map(item => `
                <div class="content-card" data-id="${item.id}">
                    <div class="card-actions">
                        ${currentStatus === 'to_complete' ? `
                            <button class="action-btn" onclick="markCompleted('${item.id}')" title="סמן כהושלם">
                                <i class="fas fa-check"></i>
                            </button>
                        ` : `
                            <button class="action-btn" onclick="markIncomplete('${item.id}')" title="החזר להשלמה">
                                <i class="fas fa-undo"></i>
                            </button>
                        `}
                        <button class="action-btn" onclick="deleteContent('${item.id}')" title="מחק">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                    
                    <img class="card-thumbnail" 
                         src="${item.thumbnail_url}" 
                         alt="${item.title}"
                         onclick="window.open('${item.youtube_url}', '_blank')">
                    
                    <div class="card-body">
                        <div class="card-title">${item.title}</div>
                        
                        <div class="card-meta">
                            <span class="card-type ${item.content_type}">
                                ${getTypeIcon(item.content_type)}
                                ${getTypeLabel(item.content_type)}
                            </span>
                            <div class="card-user">
                                <div class="user-avatar">
                                    ${item.added_by_username?.charAt(0).toUpperCase() || 'U'}
                                </div>
                                <span>${item.added_by_username || 'משתמש'}</span>
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');
        }
        
        function getTypeIcon(type) {
            const icons = {
                movie: '<i class="fas fa-film"></i>',
                series: '<i class="fas fa-tv"></i>',
                music: '<i class="fas fa-music"></i>'
            };
            return icons[type] || '';
        }
        
        function getTypeLabel(type) {
            const labels = {
                movie: 'סרט',
                series: 'סדרה',
                music: 'מוזיקה'
            };
            return labels[type] || '';
        }
        
        async function markCompleted(contentId) {
            try {
                const { error } = await supabase
                    .from('user_content')
                    .update({ 
                        status: 'completed',
                        completed_at: new Date().toISOString()
                    })
                    .eq('id', contentId)
                    .eq('user_id', currentUser.id);
                
                if (error) throw error;
                
                showToast('סומן כהושלם', 'success');
                await loadContent();
                await updateStats();
                
            } catch (error) {
                console.error('Error marking completed:', error);
                showToast('שגיאה בעדכון הסטטוס', 'error');
            }
        }
        
        async function markIncomplete(contentId) {
            try {
                const { error } = await supabase
                    .from('user_content')
                    .update({ 
                        status: 'to_complete',
                        completed_at: null
                    })
                    .eq('id', contentId)
                    .eq('user_id', currentUser.id);
                
                if (error) throw error;
                
                showToast('הוחזר להשלמה', 'success');
                await loadContent();
                await updateStats();
                
            } catch (error) {
                console.error('Error marking incomplete:', error);
                showToast('שגיאה בעדכון הסטטוס', 'error');
            }
        }
        
        async function deleteContent(contentId) {
            if (!confirm('האם אתה בטוח שברצונך למחוק תוכן זה?')) return;
            
            try {
                const { error } = await supabase
                    .from('user_content')
                    .delete()
                    .eq('id', contentId)
                    .eq('user_id', currentUser.id);
                
                if (error) throw error;
                
                showToast('התוכן נמחק בהצלחה', 'success');
                await loadContent();
                await updateStats();
                
            } catch (error) {
                console.error('Error deleting content:', error);
                showToast('שגיאה במחיקת התוכן', 'error');
            }
        }
        
        // Statistics
        async function updateStats() {
            if (!currentUser) return;
            
            try {
                const { data, error } = await supabase
                    .rpc('get_user_content_stats', { user_uuid: currentUser.id });
                
                if (error) throw error;
                
                if (data && data.length > 0) {
                    const stats = data[0];
                    document.getElementById('totalCount').textContent = stats.total_content || 0;
                    document.getElementById('toCompleteCount').textContent = stats.to_complete_count || 0;
                    document.getElementById('completedCount').textContent = stats.completed_count || 0;
                    document.getElementById('moviesCount').textContent = stats.movies_count || 0;
                    document.getElementById('seriesCount').textContent = stats.series_count || 0;
                    document.getElementById('musicCount').textContent = stats.music_count || 0;
                }
            } catch (error) {
                console.error('Error updating stats:', error);
            }
        }
        
        // Utilities
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }
        
        function showToast(message, type = 'info') {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = `toast-custom ${type}`;
            
            const icon = type === 'success' ? 'fa-check-circle' : 
                        type === 'error' ? 'fa-exclamation-circle' : 
                        'fa-info-circle';
            
            toast.innerHTML = `
                <i class="fas ${icon}"></i>
                <span>${message}</span>
            `;
            
            container.appendChild(toast);
            
            setTimeout(() => {
                toast.style.animation = 'slideIn 0.3s ease reverse';
                setTimeout(() => container.removeChild(toast), 300);
            }, 3000);
        }
    </script>
</body>
</html>
